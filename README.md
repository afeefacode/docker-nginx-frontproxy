# afeefa/docker-nginx-frontproxy

An nginx proxy server to run local projects using custom domain names and autogenerated ssl certificates.

## Description

Having multiple projects running the same time on different ports on localhost can become quite confusing. Which port serves which project? How to manage a bigger number of projects?

```bash
localhost:8080 # project 1
localhost:8081 # project 2
...
localhost:808(n-1) # project n
```

We can solve the project identification problem by creating local domain names. We can solve the port distribution problem by running the projects each inside a docker container.

```bash
project1.test # -> project-1-docker:80
project2.test # -> project-2-docker:80
...
projectn.test # -> project-n-docker:80
```

To access these projects from the host machine, e.g. via `http://project1.test`, we need now a proxy server, that maps (proxies) our local domains to docker containers.

`docker-nginx-frontproxy` is such a proxy server that:

* runs in a docker container and listens on hosts ports 443 and 80
* provides a cli to create or remove proxy configurations
* autogenerates ssl certificates for each domain added

## Architecture

* The host defines a number of local domains in its `/etc/hosts` file
* The front proxy consists of a vhost.conf for each of these local domains
* Any http request to port 80 or 443 gets delegated to the front proxy server
* The front proxy examines the requests host header field and passes the request further to the projects docker services

![architecture](https://raw.githubusercontent.com/afeefacode/docker-nginx-frontproxy/main/docs/architecture.png "architecture")

### Handling more complex projects

A project may consist of multiple sub services (frontend, backend, websockets, ...) which all should be publicly accessed. In this case it's common to put a local nginx proxy at project level in front of those sub services and provide access via custom url.

```nginx
resolver 127.0.0.11;

location /frontend/sockjs-node/ { # browsersync
    set $vue "vue:8080";
    proxy_pass http://$vue;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
}

location /frontend { # vue dev server
    set $vue "vue:8080";
    proxy_pass http://$vue;
}
```

Yes, this will make up a chain of two proxy servers (front, project).

## Installation

### Requirements

* Docker and docker-compose
* PHP >=7.4 for the cli tool
* PHP composer to install the cli tool

### Install

Checkout the project, install the cli, setup ssl certificates and localhost, start the docker container:

```bash
git clone git@github.com:afeefacode/docker-nginx-frontproxy.git
cd docker-nginx-frontproxy
composer install
./nginx-frontproxy setup
docker-compose up
```

## Adding a server

Just pass a local domain name and a corresponding docker container name. You may specify a port (if other than 80).

```bash
./nginx-frontproxy add-server my-domain.test my-domain-service
./nginx-frontproxy add-server my-other-domain.test my-other-domain-service:8080
```

It's also possible to proxy a non docker localhost service:

```bash
./nginx-frontproxy add-server my-nondocker-domain.test localhost:8080
```


Don't forget to add the domain to your local `/etc/hosts` file.

```bash
127.0.0.1 localhost
127.0.0.1 my-domain.test # <-- added
127.0.0.1 my-other-local-domain.test
```

You might use the [hostess](https://github.com/cbednarski/hostess) tool.

```
hostess add my-domain.test 127.0.0.1
```

## Removing a server

```bash
./nginx-frontproxy remove-server my-domain.test
```

Don't forget to remove the domain from your local `/etc/hosts` file.

You might use the hostess tool (see above).

```bash
hostess rm my-domain.test
```
